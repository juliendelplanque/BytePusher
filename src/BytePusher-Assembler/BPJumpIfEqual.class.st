"
Let the instruction pointer do a jump to the defined address if ZERO flag is TRUE.

JE address
"
Class {
	#name : #BPJumpIfEqual,
	#superclass : #BPAssemblerInstruction,
	#instVars : [
		'address'
	],
	#pools : [
		'BPConstants'
	],
	#category : #'BytePusher-Assembler-Assembler'
}

{ #category : #accessing }
BPJumpIfEqual >> address [
	^ address
]

{ #category : #accessing }
BPJumpIfEqual >> address: anObject [
	address := anObject
]

{ #category : #generating }
BPJumpIfEqual >> generateFor: anAssembler [
	| jmpAddress instruction1 instruction2 instruction3 instruction4 instruction5 instruction6 instruction7 |
	jmpAddress := self address forAssembler: anAssembler.
	instruction1 := self newInstruction
		from: jmpAddress asDataReference; "Copy byte 0 of jmpAddress"
		to: (anAssembler reservedMemoryZoneNamed: #JUMP_IF_NONZERO) + (2 * ADDRESS_SIZE);
		beAddedTo: anAssembler
		yourself.
	instruction2 := self newInstruction
		from: (jmpAddress asDataReference offset: 1); "Copy byte 1 of jmpAddress"
		to: (anAssembler reservedMemoryZoneNamed: #JUMP_IF_NONZERO) + (2 * ADDRESS_SIZE + 1);
		beAddedTo: anAssembler
		yourself.
	instruction3 := self newInstruction
		from: (jmpAddress asDataReference offset: 2); "Copy byte 2 of jmpAddress"
		to: (anAssembler reservedMemoryZoneNamed: #JUMP_IF_NONZERO) + (2 * ADDRESS_SIZE + 2);
		beAddedTo: anAssembler
		yourself.
		
	instruction4 := self newInstruction
		"Copy byte 0 of instruction generated after the ones generated by this method"
		from: (BPNextInstructionReference offset: 3) asDataReference;
		to: (anAssembler reservedMemoryZoneNamed: #JUMP_IF_ZERO) + (2 * ADDRESS_SIZE);
		beAddedTo: anAssembler
		yourself.
	instruction5 := self newInstruction
		"Copy byte 1 of instruction generated after the ones generated by this method"
		from: ((BPNextInstructionReference offset: 2) asDataReference offset: 1);
		to: (anAssembler reservedMemoryZoneNamed: #JUMP_IF_ZERO) + (2 * ADDRESS_SIZE + 1);
		beAddedTo: anAssembler
		yourself.
	instruction6 := self newInstruction
		"Copy byte 2 of instruction generated after the ones generated by this method"
		from: ((BPNextInstructionReference offset: 1) asDataReference offset: 2);
		to: (anAssembler reservedMemoryZoneNamed: #JUMP_IF_ZERO) + (2 * ADDRESS_SIZE + 2);
		beAddedTo: anAssembler
		yourself.
	
	instruction7 := self newInstruction
		from: (anAssembler registerNamed: #ZERO);
		yourself.
	instruction7
		to: (instruction7 asReference offset: 8);
		"The lower-byte of this address will be overwritten by the instruction to point
		 to either #JUMP_IF_ZERO or #JUMP_IF_NONZERO.
		"
		jump: (anAssembler reservedMemoryZoneNamed: #JUMP_IF_ZERO);
		beAddedTo: anAssembler.
	instruction1
		jump: instruction2 asReference.
	instruction2
		jump: instruction3 asReference.
	instruction3
		jump: instruction4 asReference.
	instruction4
		jump: instruction5 asReference.
	instruction5
		jump: instruction6 asReference.
	instruction6
		jump: instruction7 asReference.
]
